from fastapi import FastAPI
from pydantic import BaseModel
import pandas as pd
import joblib
import os

MODEL_FILE = "/app/model/traffic_model.pkl"

# loading the model
model = joblib.load(MODEL_FILE)

app = FastAPI(title="Traffic prediction API")

# defining the input schema
class TrafficInput(BaseModel):
    road_id: str
    weather: str
    congestion_level: str
    avg_speed: float
    accident_flag: int


def preprocess_input(data: TrafficInput):
    df = pd.Dataframe([data.dict()])    

    # use one-hot encode for the weather and the road_id
    df = pd.get_dummies(df, columns=["road_id", "weather"])

    # congestion levels on the map
    df["congestion_level"] = df["congestion_level"].map({"low": 0, "medium": 1, "high": 2}).fillna(1)


    model_columns = model.feature_names_in_
    for col in model_columns:
        if col not in df.columns:
            df[col] = 0
    df = df[model_columns]
    return df


@app.post("predict")
def predict_traffic(input: TrafficInput):
    X = preprocess_input(input)
    pred = model.predict(X)
    return{"The predicted_vehicle_count": int(pred[0])}
